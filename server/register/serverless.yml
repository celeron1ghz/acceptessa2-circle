service: acceptessa2-circle-api-register
frameworkVersion: '2'

provider:
  name: aws
  runtime: nodejs12.x
  lambdaHashingVersion: 20201221
  stage: dev
  region: ap-northeast-1
  iam:
    role:
      statements:
        - Effect: Allow
          Action: [dynamodb:GetItem, dynamodb:PutItem, dynamodb:DeleteItem]
          Resource: { Fn::GetAtt: [RegisterTable, Arn] }
        - Effect: Allow
          Action: [dynamodb:GetItem]
          Resource:
            - Fn::Join: [ ":", ["arn:aws:dynamodb", { Ref: AWS::Region }, { Ref: AWS::AccountId }, "table/acceptessa2-exhibition"]]
        - Effect: Allow
          Action: [lambda:InvokeFunction]
          Resource:
            - Fn::Join: [ ":", ["arn:aws:lambda", { Ref: AWS::Region }, { Ref: AWS::AccountId }, "function:acceptessa2-mail-sender"]]

functions:
  validate:
    handler: handler.validate_mail
    timeout: 10
    events:
      - httpApi:
          path: /register/validate
          method: get

  check:
    handler: handler.check_mail
    timeout: 10
    events:
      - httpApi:
          path: /register/check
          method: get

resources:
  Resources:
    RegisterTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: acceptessa2-circle-register
        AttributeDefinitions:
          - { AttributeName: token, AttributeType: S }
        KeySchema:
          - { AttributeName: token, KeyType: HASH }
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
